<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="site-title">Cosmic Wonders</title>
    <style>
        :root {
            /* Space Theme Colors */
            --bg-color-primary: #1A0033; /* Very Dark Purple */
            --bg-color-secondary: #330066; /* Dark Purple */
            --text-color: #E0E0FF; /* Light Lavender/Blue */
            --footer-bg: #0D001A; /* Even Darker Purple */
            --glass-bg: rgba(51, 0, 102, 0.7); /* Semi-transparent dark purple */
            --glass-border: rgba(224, 224, 255, 0.3); /* Light lavender border */
            --fact-text-shadow: 2px 2px 15px rgba(0,0,0,0.9);
            --title-color: #FFD700; /* Gold */
            --title-shadow: 4px 4px 25px rgba(0, 0, 0, 0.9);
            --main-action-btn: #8A2BE2; /* Blue Violet */
            --main-action-btn-hover: #6A1B9A; /* Dark Violet */
            --theme-indicator-color: #FFD700; /* Gold */
            --favorite-btn-color: #FFD700; /* Gold */
            --favorite-btn-hover: #B8860B; /* Dark Goldenrod */
            --share-btn-color: #4CAF50; /* Green */
            --share-btn-hover: #388E3C; /* Dark Green */
            --rating-active-color: #8A2BE2; /* Blue Violet */
            --rating-text-color: #E0E0FF; /* Light Lavender/Blue */
            --category-select-bg: #330066; /* Dark Purple for select */
            --category-select-border: #8A2BE2; /* Blue Violet border */
            --search-input-bg: rgba(255, 255, 255, 0.1);
            --search-input-border: rgba(224, 224, 255, 0.5);
            --search-input-text: #E0E0FF;
            --fact-card-bg: rgba(51, 0, 102, 0.8); /* Slightly darker glass for fact card */
            --fact-card-border: rgba(255, 215, 0, 0.5); /* Gold border for emphasis */
            --fact-of-day-glow: 0 0 20px rgba(255, 215, 0, 0.7); /* Gold glow */
            --carousel-control-color: #FFD700; /* Gold for carousel controls */
            --carousel-control-hover: #FFFF00; /* Yellow */
            --trivia-correct-color: #4CAF50; /* Green */
            --trivia-incorrect-color: #F44336; /* Red */
            --streak-color: #FFD700; /* Gold for streak */
            --streak-glow: 0 0 15px rgba(255, 215, 0, 0.5);
            --quiz-correct-color: #4CAF50; /* Green */
            --quiz-incorrect-color: #F44336; /* Red */
        }

        body {
            background: linear-gradient(135deg, var(--bg-color-primary) 0%, var(--bg-color-secondary) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            transition: background 1.5s ease-in-out, color 0.8s ease;
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 40px 60px;
            margin: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            max-width: 800px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            transition: all 0.5s ease;
            animation: fadeInScale 0.8s ease-out forwards;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        h1 {
            color: var(--title-color);
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: var(--title-shadow);
            transition: color 0.5s ease;
        }

        #fact-display, #challenge-fact-display, #trivia-fact-display, #scramble-fact-display {
            font-size: 2.2rem;
            font-weight: 500;
            margin: 30px 0 15px 0;
            line-height: 1.4;
            text-shadow: var(--fact-text-shadow);
            color: var(--text-color);
            transition: color 0.5s ease, transform 0.5s ease, opacity 0.5s ease, filter 0.5s ease; /* Added filter */
            opacity: 1; /* Fact is visible by default */
            transform: translateY(0); /* Fact is visible by default */
        }

        .blurred-fact {
            filter: blur(8px); /* Blur effect */
            cursor: pointer; /* Indicate it's clickable */
        }

        .fact-card {
            background-color: var(--fact-card-bg);
            border: 2px solid var(--fact-card-border);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            width: 90%;
            max-width: 600px;
            transition: all 0.5s ease;
            position: relative; /* For carousel controls */
        }

        .action-button {
            background-color: var(--main-action-btn);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.3rem;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: 20px;
        }

        .action-button:hover {
            background-color: var(--main-action-btn-hover);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .action-button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .rating-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .rating-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .rating-button {
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 10px 15px;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .rating-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .rating-button.active {
            background-color: var(--rating-active-color);
            color: white;
            border-color: var(--rating-active-color);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #popularity-score {
            font-size: 1.1rem;
            color: var(--rating-text-color);
            margin-top: 10px;
            font-weight: bold;
        }

        .theme-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--glass-bg);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--theme-indicator-color);
            border: 1px solid var(--glass-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .favorite-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2.5rem;
            cursor: pointer;
            color: var(--favorite-btn-color);
            transition: transform 0.2s ease, color 0.2s ease;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .favorite-button:hover {
            transform: scale(1.1);
            color: var(--favorite-btn-hover);
        }

        .favorite-button.favorited {
            color: var(--favorite-btn-hover);
            text-shadow: 0 0 15px var(--favorite-btn-color);
            transform: scale(1.1);
        }

        .utility-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .utility-buttons .action-button {
            margin-top: 0;
            background-color: var(--share-btn-color);
        }

        .utility-buttons .action-button:hover {
            background-color: var(--share-btn-hover);
        }

        footer {
            margin-top: 40px;
            padding: 15px 30px;
            background-color: var(--footer-bg);
            color: var(--text-color);
            width: 100%;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            font-size: 0.9rem;
            transition: background-color 0.8s ease, color 0.8s ease;
        }

        /* Category Selector */
        .category-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-selector label {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .category-selector select {
            background-color: var(--category-select-bg);
            color: var(--text-color);
            border: 1px solid var(--category-select-border);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23E0F2F7%22%20d%3D%22M287%2C197.9L159.3%2C69.2c-3.7-3.7-9.7-3.7-13.4%2C0L5.4%2C197.9c-3.7%2C3.7-3.7%2C9.7%2C0%2C13.4l13.4%2C13.4c3.9%2C3.9%2C10.1%2C3.9%2C14%2C0l110.7-110.7l110.7%2C110.7c3.9%2C3.9%2C10.1%2C3.9%2C14%2C0l13.4-13.4C290.7%2C207.6%2C290.7%2C201.6%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .category-selector select:focus {
            outline: none;
            border-color: var(--main-action-btn-hover);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.3);
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
        }

        .search-bar input {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--search-input-border);
            background-color: var(--search-input-bg);
            color: var(--search-input-text);
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .search-bar input::placeholder {
            color: rgba(224, 242, 247, 0.7);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--main-action-btn-hover);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.3);
        }

        .search-bar .action-button {
            margin-top: 0;
            padding: 10px 20px;
            font-size: 1rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            padding-top: 60px;
        }

        .modal-content {
            background-color: var(--glass-bg);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            width: 80%;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            color: var(--text-color);
        }

        .modal-content h2 {
            color: var(--title-color);
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: var(--title-shadow);
        }

        .modal-content ul {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid var(--glass-border);
            padding-top: 15px;
        }

        .modal-content li {
            background-color: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            text-align: left;
            font-size: 1.1rem;
            border: 1px solid rgba(255,255,255,0.1);
            transition: background-color 0.3s ease;
        }

        .modal-content li:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .close-button {
            color: var(--text-color);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--title-color);
            text-decoration: none;
            cursor: pointer;
        }

        /* Quiz Specific Styles */
        .quiz-options button, .challenge-options button, .trivia-options button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background-color: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .quiz-options button:hover, .challenge-options button:hover, .trivia-options button:hover {
            background-color: rgba(255,255,255,0.1);
            border-color: var(--main-action-btn);
        }

        .quiz-options button.correct, .challenge-options button.correct, .trivia-options button.correct {
            background-color: var(--quiz-correct-color);
            border-color: var(--quiz-correct-color);
            color: white;
        }

        .quiz-options button.incorrect, .challenge-options button.incorrect, .trivia-options button.incorrect {
            background-color: var(--quiz-incorrect-color);
            border-color: var(--quiz-incorrect-color);
            color: white;
        }

        #quiz-feedback, #challenge-feedback, #trivia-feedback, #scramble-feedback {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Fact of the Day Section */
        #fact-of-the-day-section {
            display: none; /* Hidden by default */
            background-color: var(--fact-card-bg);
            border: 3px solid var(--fact-card-border);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: var(--fact-of-day-glow);
            width: 90%;
            max-width: 700px;
            animation: fadeInScale 0.8s ease-out forwards;
            position: relative;
        }

        #fact-of-the-day-section h2 {
            color: var(--title-color);
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: var(--title-shadow);
        }

        #fact-of-the-day-content {
            font-size: 2.5rem;
            font-weight: 600;
            line-height: 1.5;
            color: var(--text-color);
            text-shadow: var(--fact-text-shadow);
            margin-bottom: 20px;
        }

        #next-fact-of-day-countdown {
            font-size: 1.2rem;
            color: var(--theme-indicator-color);
            font-weight: bold;
        }

        /* Carousel Controls */
        .carousel-controls {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 10px;
            box-sizing: border-box;
        }

        .carousel-control-btn {
            background: none;
            border: none;
            font-size: 3rem;
            color: var(--carousel-control-color);
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .carousel-control-btn:hover {
            color: var(--carousel-control-hover);
            transform: scale(1.1);
        }

        .carousel-play-pause-btn {
            background-color: var(--main-action-btn);
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
        }

        .carousel-play-pause-btn:hover {
            background-color: var(--main-action-btn-hover);
            transform: translateY(-2px);
        }

        /* More Options Button */
        #more-options-btn {
            margin-top: 30px;
            background-color: var(--theme-indicator-color);
            color: var(--bg-color-primary);
            font-weight: bold;
        }

        #more-options-btn:hover {
            background-color: var(--favorite-btn-hover);
            color: white;
        }

        /* Fact Streak Feature */
        .fact-streak-section {
            margin-top: 20px;
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 15px 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: var(--streak-color);
            text-shadow: var(--streak-glow);
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .fact-streak-section.active-streak {
            animation: streakGlowPulse 1.5s infinite alternate;
        }

        @keyframes streakGlowPulse {
            from { box-shadow: 0 2px 10px rgba(0,0,0,0.3), var(--streak-glow); }
            to { box-shadow: 0 2px 15px rgba(0,0,0,0.5), 0 0 25px rgba(255, 215, 0, 0.8); }
        }

        #current-streak {
            font-size: 1.8rem;
            color: var(--streak-color);
        }

        #claim-streak-btn {
            background-color: var(--streak-color);
            color: var(--bg-color-primary);
            font-weight: bold;
            padding: 10px 20px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #claim-streak-btn:hover {
            background-color: var(--carousel-control-hover);
            transform: translateY(-2px);
        }

        /* New Fact Discovery Animation */
        .fact-display-animation {
            animation: factPopIn 0.5s ease-out forwards;
        }

        @keyframes factPopIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Fact Scramble Specific Styles */
        .scramble-input {
            width: 90%;
            padding: 10px 15px;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid var(--search-input-border);
            background-color: var(--search-input-bg);
            color: var(--search-input-text);
            font-size: 1.1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .scramble-input:focus {
            outline: none;
            border-color: var(--main-action-btn-hover);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.3);
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            #fact-display, #challenge-fact-display, #fact-of-the-day-content, #trivia-fact-display, #scramble-fact-display {
                font-size: 1.5rem;
            }
            #fact-of-the-day-section h2 {
                font-size: 2rem;
            }
            .container {
                padding: 30px;
            }
            .action-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            .utility-buttons {
                flex-direction: column;
                align-items: center;
            }
            .search-bar {
                flex-direction: column;
                align-items: center;
            }
            .search-bar input {
                width: 100%;
            }
            .carousel-control-btn {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="theme-indicator">Theme: <span id="current-theme">Cosmic Wonders</span></div>
        <h1 id="site-title">Cosmic Wonders</h1>

        <div class="category-selector">
            <label for="fact-category">Category:</label>
            <select id="fact-category">
                <option value="deep-sea">Deep Sea</option>
                <option value="space" selected>Space</option>
                <option value="history">History</option>
                <option value="science">Science</option>
            </select>
        </div>

        <div class="fact-card">
            <p id="fact-display" class="fact-display-animation">A day on Venus is longer than a year on Venus.</p>
            <div class="carousel-controls">
                <button class="carousel-control-btn" id="prev-fact-btn" title="Previous Fact">◀</button>
                <button class="carousel-control-btn" id="next-fact-btn" title="Next Fact">▶</button>
            </div>
        </div>
        <button class="carousel-play-pause-btn" id="play-pause-carousel-btn">Pause Carousel</button>
        <button class="action-button" id="reveal-fact-btn" style="margin-top: 10px;">Reveal Fact</button>

        <div class="rating-section">
            <div id="popularity-score">Rating: 0</div>
            <div class="rating-buttons">
                <button class="rating-button" id="thumbs-up-btn" title="Like this fact">👍</button>
                <button class="rating-button" id="thumbs-down-btn" title="Dislike this fact">👎</button>
            </div>
        </div>
        <button class="favorite-button" id="favorite-btn" title="Add to favorites">⭐</button>

        <div class="fact-streak-section">
            <div id="current-streak">Fact Streak: 0</div>
            <button class="action-button" id="claim-streak-btn">Claim Streak Bonus!</button>
        </div>

        <button class="action-button" id="discover-new-fact-btn">Discover New Fact!</button>
        <button class="action-button" id="more-options-btn">More Options</button>

        <div class="utility-buttons" style="display: none;">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search for facts...">
                <button class="action-button" id="search-fact-btn">Search</button>
            </div>
            <button class="action-button" id="share-fact-btn">Share Fact</button>
            <button class="action-button" id="view-history-btn">View History</button>
            <button class="action-button" id="view-favorites-btn">View Favorites</button>
            <button class="action-button" id="fact-of-the-day-btn">Fact of the Day</button>
            <button class="action-button" id="quiz-me-btn">Quiz Me!</button>
            <button class="action-button" id="fact-challenge-btn">Fact Challenge!</button>
            <button class="action-button" id="fact-trivia-btn">Fact Trivia!</button>
            <button class="action-button" id="fact-scramble-btn">Fact Scramble!</button> <!-- New Feature Button -->
        </div>
    </div>

    <div id="fact-of-the-day-section">
        <h2>Fact of the Day!</h2>
        <p id="fact-of-the-day-content"></p>
        <p id="next-fact-of-day-countdown">Next fact in: --:--:--</p>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-history-modal">&times;</span>
            <h2>Fact History</h2>
            <ul id="history-list">
                <!-- History items will be loaded here -->
            </ul>
        </div>
    </div>

    <div id="favorites-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-favorites-modal">&times;</span>
            <h2>Favorite Facts</h2>
            <ul id="favorites-list">
                <!-- Favorite items will be loaded here -->
            </ul>
        </div>
    </div>

    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-quiz-modal">&times;</span>
            <h2>Fact Quiz</h2>
            <p id="quiz-question"></p>
            <div class="quiz-options" id="quiz-options">
                <!-- Quiz options will be loaded here -->
            </div>
            <p id="quiz-feedback"></p>
            <button class="action-button" id="next-quiz-btn" style="display: none; margin-top: 20px;">Next Question</button>
        </div>
    </div>

    <div id="search-results-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-search-results-modal">&times;</span>
            <h2>Search Results</h2>
            <ul id="search-results-list">
                <!-- Search results will be loaded here -->
            </ul>
        </div>
    </div>

    <div id="fact-challenge-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-fact-challenge-modal">&times;</span>
            <h2>Fact Category Challenge</h2>
            <p id="challenge-fact-display"></p>
            <div class="challenge-options" id="challenge-options">
                <!-- Category options will be loaded here -->
            </div>
            <p id="challenge-feedback"></p>
            <button class="action-button" id="next-challenge-btn" style="display: none; margin-top: 20px;">Next Challenge</button>
        </div>
    </div>

    <div id="fact-trivia-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-fact-trivia-modal">&times;</span>
            <h2>Fact Trivia!</h2>
            <p id="trivia-fact-display"></p>
            <div class="trivia-options" id="trivia-options">
                <!-- Trivia options will be loaded here -->
            </div>
            <p id="trivia-feedback"></p>
            <button class="action-button" id="next-trivia-btn" style="display: none; margin-top: 20px;">Next Trivia</button>
        </div>
    </div>

    <!-- New Fact Scramble Modal -->
    <div id="fact-scramble-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-fact-scramble-modal">&times;</span>
            <h2>Fact Scramble!</h2>
            <p id="scramble-fact-display" style="font-size: 1.8rem; font-weight: bold; margin-bottom: 20px;"></p>
            <input type="text" id="scramble-input" class="scramble-input" placeholder="Type the correct fact here...">
            <p id="scramble-feedback"></p>
            <button class="action-button" id="check-scramble-btn">Check Answer</button>
            <button class="action-button" id="next-scramble-btn" style="display: none; margin-top: 10px;">Next Scramble</button>
        </div>
    </div>

    <footer>
        <p>Site will update automatically. Last update: <span id="last-update-time"></span></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const factDisplay = document.getElementById('fact-display');
            const prevFactBtn = document.getElementById('prev-fact-btn');
            const nextFactBtn = document.getElementById('next-fact-btn'); // Kept for carousel logic
            const playPauseCarouselBtn = document.getElementById('play-pause-carousel-btn');
            const thumbsUpBtn = document.getElementById('thumbs-up-btn');
            const thumbsDownBtn = document.getElementById('thumbs-down-btn');
            const popularityScore = document.getElementById('popularity-score');
            const favoriteBtn = document.getElementById('favorite-btn');
            const shareFactBtn = document.getElementById('share-fact-btn');
            const viewHistoryBtn = document.getElementById('view-history-btn');
            const viewFavoritesBtn = document.getElementById('view-favorites-btn');
            const factOfTheDayBtn = document.getElementById('fact-of-the-day-btn');
            const quizMeBtn = document.getElementById('quiz-me-btn');
            const searchInput = document.getElementById('search-input');
            const searchFactBtn = document.getElementById('search-fact-btn');
            const factChallengeBtn = document.getElementById('fact-challenge-btn');
            const factTriviaBtn = document.getElementById('fact-trivia-btn');
            const factScrambleBtn = document.getElementById('fact-scramble-btn'); // New button
            const moreOptionsBtn = document.getElementById('more-options-btn');
            const utilityButtonsContainer = document.querySelector('.utility-buttons');
            const discoverNewFactBtn = document.getElementById('discover-new-fact-btn'); // New button
            const revealFactBtn = document.getElementById('reveal-fact-btn'); // New button

            const historyModal = document.getElementById('history-modal');
            const favoritesModal = document.getElementById('favorites-modal');
            const quizModal = document.getElementById('quiz-modal');
            const searchResultsModal = document.getElementById('search-results-modal');
            const factChallengeModal = document.getElementById('fact-challenge-modal');
            const factTriviaModal = document.getElementById('fact-trivia-modal');
            const factScrambleModal = document.getElementById('fact-scramble-modal'); // New modal

            const closeHistoryModal = document.getElementById('close-history-modal');
            const closeFavoritesModal = document.getElementById('close-favorites-modal');
            const closeQuizModal = document.getElementById('close-quiz-modal');
            const closeSearchResultsModal = document.getElementById('close-search-results-modal');
            const closeFactChallengeModal = document.getElementById('close-fact-challenge-modal');
            const closeFactTriviaModal = document.getElementById('close-fact-trivia-modal');
            const closeFactScrambleModal = document.getElementById('close-fact-scramble-modal'); // New close button

            const historyList = document.getElementById('history-list');
            const favoritesList = document.getElementById('favorites-list');
            const quizQuestion = document.getElementById('quiz-question');
            const quizOptions = document.getElementById('quiz-options');
            const quizFeedback = document.getElementById('quiz-feedback');
            const nextQuizBtn = document.getElementById('next-quiz-btn');
            const searchResultsList = document.getElementById('search-results-list');

            const challengeFactDisplay = document.getElementById('challenge-fact-display');
            const challengeOptions = document.getElementById('challenge-options');
            const challengeFeedback = document.getElementById('challenge-feedback');
            const nextChallengeBtn = document.getElementById('next-challenge-btn');

            const triviaFactDisplay = document.getElementById('trivia-fact-display');
            const triviaOptions = document.getElementById('trivia-options');
            const triviaFeedback = document.getElementById('trivia-feedback');
            const nextTriviaBtn = document.getElementById('next-trivia-btn');

            const scrambleFactDisplay = document.getElementById('scramble-fact-display'); // New element
            const scrambleInput = document.getElementById('scramble-input'); // New element
            const scrambleFeedback = document.getElementById('scramble-feedback'); // New element
            const checkScrambleBtn = document.getElementById('check-scramble-btn'); // New element
            const nextScrambleBtn = document.getElementById('next-scramble-btn'); // New element


            const lastUpdateTime = document.getElementById('last-update-time');
            const factCategorySelect = document.getElementById('fact-category');
            const siteTitle = document.getElementById('site-title');
            const currentThemeIndicator = document.getElementById('current-theme');

            const factOfTheDaySection = document.getElementById('fact-of-the-day-section');
            const factOfTheDayContent = document.getElementById('fact-of-the-day-content');
            const nextFactOfDayCountdown = document.getElementById('next-fact-of-day-countdown');

            const currentStreakDisplay = document.getElementById('current-streak');
            const claimStreakBtn = document.getElementById('claim-streak-btn');
            const factStreakSection = document.querySelector('.fact-streak-section');

            let currentFact = {
                text: "",
                category: "",
                rating: 0
            };
            let factHistory = [];
            let favoriteFacts = [];
            let carouselInterval;
            let isCarouselPlaying = true;
            const CAROUSEL_SPEED = 5000; // 5 seconds
            let factStreak = 0;

            const themes = {
                "deep-sea": {
                    title: "Mysteries of the Deep Sea",
                    primaryBg: "#0A1931",
                    secondaryBg: "#152A46",
                    textColor: "#E0F2F7",
                    footerBg: "#050F1A",
                    glassBg: "rgba(10, 25, 49, 0.7)",
                    glassBorder: "rgba(224, 242, 247, 0.3)",
                    titleColor: "#00BCD4",
                    mainActionBtn: "#00BCD4",
                    mainActionBtnHover: "#00838F",
                    themeIndicatorColor: "#00BCD4",
                    favoriteBtnColor: "#FFD700",
                    favoriteBtnHover: "#B8860B",
                    shareBtnColor: "#20B2AA",
                    shareBtnHover: "#1A8B84",
                    ratingActiveColor: "#00BCD4",
                    ratingTextColor: "#E0F2F7",
                    categorySelectBg: "#152A46",
                    categorySelectBorder: "#00BCD4",
                    searchInputBg: "rgba(255, 255, 255, 0.1)",
                    searchInputBorder: "rgba(224, 242, 247, 0.5)",
                    searchInputText: "#E0F2F7",
                    factCardBg: "rgba(10, 25, 49, 0.8)",
                    factCardBorder: "rgba(0, 188, 212, 0.5)",
                    factOfDayGlow: "0 0 20px rgba(0, 188, 212, 0.7)",
                    carouselControlColor: "#00BCD4",
                    carouselControlHover: "#00E5FF",
                    triviaCorrectColor: "#4CAF50",
                    triviaIncorrectColor: "#F44336",
                    streakColor: "#FFD700", /* Gold for streak */
                    streakGlow: "0 0 15px rgba(255, 215, 0, 0.5)",
                },
                "space": {
                    title: "Cosmic Wonders",
                    primaryBg: "#1A0033",
                    secondaryBg: "#330066",
                    textColor: "#E0E0FF",
                    footerBg: "#0D001A",
                    glassBg: "rgba(51, 0, 102, 0.7)",
                    glassBorder: "rgba(224, 224, 255, 0.3)",
                    titleColor: "#FFD700",
                    mainActionBtn: "#8A2BE2",
                    mainActionBtnHover: "#6A1B9A",
                    themeIndicatorColor: "#FFD700",
                    favoriteBtnColor: "#FFD700",
                    favoriteBtnHover: "#B8860B",
                    shareBtnColor: "#4CAF50",
                    shareBtnHover: "#388E3C",
                    ratingActiveColor: "#8A2BE2",
                    ratingTextColor: "#E0E0FF",
                    categorySelectBg: "#330066",
                    categorySelectBorder: "#8A2BE2",
                    searchInputBg: "rgba(255, 255, 255, 0.1)",
                    searchInputBorder: "rgba(224, 224, 255, 0.5)",
                    searchInputText: "#E0E0FF",
                    factCardBg: "rgba(51, 0, 102, 0.8)",
                    factCardBorder: "rgba(255, 215, 0, 0.5)",
                    factOfDayGlow: "0 0 20px rgba(255, 215, 0, 0.7)",
                    carouselControlColor: "#FFD700",
                    carouselControlHover: "#FFFF00",
                    triviaCorrectColor: "#4CAF50",
                    triviaIncorrectColor: "#F44336",
                    streakColor: "#FFD700", /* Gold for streak */
                    streakGlow: "0 0 15px rgba(255, 215, 0, 0.5)",
                },
                "history": {
                    title: "Echoes of the Past",
                    primaryBg: "#4A3728",
                    secondaryBg: "#6F543E",
                    textColor: "#F5E6D3",
                    footerBg: "#4F3A2C",
                    glassBg: "rgba(74, 55, 40, 0.7)",
                    glassBorder: "rgba(245, 230, 211, 0.3)",
                    titleColor: "#D4AF37", /* Gold */
                    mainActionBtn: "#A0522D", /* Sienna */
                    mainActionBtnHover: "#8B4513", /* SaddleBrown */
                    themeIndicatorColor: "#D4AF37",
                    favoriteBtnColor: "#FFD700",
                    favoriteBtnHover: "#B8860B",
                    shareBtnColor: "#6B8E23", /* OliveDrab */
                    shareBtnHover: "#556B2F", /* DarkOliveGreen */
                    ratingActiveColor: "#A0522D",
                    ratingTextColor: "#F5E6D3",
                    categorySelectBg: "#6F543E",
                    categorySelectBorder: "#A0522D",
                    searchInputBg: "rgba(255, 255, 255, 0.1)",
                    searchInputBorder: "rgba(245, 230, 211, 0.5)",
                    searchInputText: "#F5E6D3",
                    factCardBg: "rgba(74, 55, 40, 0.8)",
                    factCardBorder: "rgba(212, 175, 55, 0.5)",
                    factOfDayGlow: "0 0 20px rgba(212, 175, 55, 0.7)",
                    carouselControlColor: "#D4AF37",
                    carouselControlHover: "#FFD700",
                    triviaCorrectColor: "#4CAF50",
                    triviaIncorrectColor: "#F44336",
                    streakColor: "#FFD700", /* Gold for streak */
                    streakGlow: "0 0 15px rgba(255, 215, 0, 0.5)",
                },
                "science": {
                    title: "Scientific Wonders",
                    primaryBg: "#2C3E50",
                    secondaryBg: "#34495E",
                    textColor: "#ECF0F1",
                    footerBg: "#212F3D",
                    glassBg: "rgba(44, 62, 80, 0.7)",
                    glassBorder: "rgba(236, 240, 241, 0.3)",
                    titleColor: "#2ECC71", /* Emerald Green */
                    mainActionBtn: "#3498DB", /* Peter River */
                    mainActionBtnHover: "#2980B9", /* Belize Hole */
                    themeIndicatorColor: "#2ECC71",
                    favoriteBtnColor: "#FFD700",
                    favoriteBtnHover: "#B8860B",
                    shareBtnColor: "#9B59B6", /* Amethyst */
                    shareBtnHover: "#8E44AD", /* Wisteria */
                    ratingActiveColor: "#3498DB",
                    ratingTextColor: "#ECF0F1",
                    categorySelectBg: "#34495E",
                    categorySelectBorder: "#3498DB",
                    searchInputBg: "rgba(255, 255, 255, 0.1)",
                    searchInputBorder: "rgba(236, 240, 241, 0.5)",
                    searchInputText: "#ECF0F1",
                    factCardBg: "rgba(44, 62, 80, 0.8)",
                    factCardBorder: "rgba(46, 204, 113, 0.5)",
                    factOfDayGlow: "0 0 20px rgba(46, 204, 113, 0.7)",
                    carouselControlColor: "#2ECC71",
                    carouselControlHover: "#66FF99",
                    triviaCorrectColor: "#4CAF50",
                    triviaIncorrectColor: "#F44336",
                    streakColor: "#FFD700", /* Gold for streak */
                    streakGlow: "0 0 15px rgba(255, 215, 0, 0.5)",
                }
            };

            const facts = {
                "deep-sea": [
                    "The Mariana Trench is deeper than Mount Everest is tall, reaching approximately 11,000 meters (36,000 feet) below the surface.",
                    "Over 80% of our oceans remain unmapped, unobserved, and unexplored.",
                    "The deepest living fish, the Mariana snailfish, can withstand pressures equivalent to 1,600 elephants standing on a Mini Cooper.",
                    "Hydrothermal vents on the ocean floor can reach temperatures of over 400°C (750°F) but don't boil due to immense pressure.",
                    "The 'twilight zone' (mesopelagic zone) of the ocean, between 200 and 1,000 meters deep, is home to the largest migration of animals on Earth, occurring daily."
                ],
                "space": [
                    "A day on Venus is longer than a year on Venus.",
                    "There are more stars in the universe than grains of sand on all the beaches on Earth.",
                    "The largest known asteroid, Ceres, is also classified as a dwarf planet.",
                    "If you could fly to the nearest star, Proxima Centauri, it would take you about 73,000 years with current spacecraft technology.",
                    "The footprints left on the Moon by Apollo astronauts will likely stay there for at least 100 million years."
                ],
                "history": [
                    "The shortest war in history was between Britain and Zanzibar on August 27, 1896. Zanzibar surrendered after 38 minutes.",
                    "Ancient Romans used to clean and whiten their teeth with a mixture of urine and goat's milk.",
                    "The Great Wall of China is not visible from space with the naked eye, contrary to popular belief.",
                    "The first recorded use of the word 'hello' was in 1827.",
                    "Cleopatra lived closer in time to the invention of the iPhone than to the building of the Great Pyramid of Giza."
                ],
                "science": [
                    "Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old and still edible.",
                    "A single cloud can weigh more than 1 million pounds.",
                    "The human brain generates about 20 watts of electrical power when awake, enough to light a dim lightbulb.",
                    "Sound travels about 4.3 times faster in water than in air.",
                    "If you unravel all the DNA in your body, it would stretch from the Earth to the Sun and back over 600 times."
                ]
            };

            const quizzes = {
                "deep-sea": [
                    {
                        question: "What is the deepest known part of the Earth's oceans?",
                        options: ["Puerto Rico Trench", "Java Trench", "Mariana Trench", "Kermadec Trench"],
                        answer: "Mariana Trench"
                    },
                    {
                        question: "What percentage of the ocean remains unmapped and unexplored?",
                        options: ["Less than 10%", "About 25%", "Around 50%", "Over 80%"],
                        answer: "Over 80%"
                    }
                ],
                "space": [
                    {
                        question: "Which planet has a day longer than its year?  ",
                        options: ["Mars", "Venus", "Jupiter", "Mercury"],
                        answer: "Venus"
                    },
                    {
                        question: "What is the largest known asteroid, also classified as a dwarf planet?",
                        options: ["Vesta", "Pallas", "Hygiea", "Ceres"],
                        answer: "Ceres"
                    }
                ],
                "history": [
                    {
                        question: "What was the shortest war in recorded history?",
                        options: ["The Six-Day War", "Anglo-Zanzibar War", "Falklands War", "Ten-Day War"],
                        answer: "Anglo-Zanzibar War"
                    },
                    {
                        question: "Cleopatra lived closer in time to which of these events?",
                        options: ["Building of the Great Pyramid", "Founding of Rome", "Invention of the iPhone", "Life of Julius Caesar"],
                        answer: "Invention of the iPhone"
                    }
                ],
                "science": [
                    {
                        question: "Which food item never spoils?",
                        options: ["Milk", "Bread", "Honey", "Cheese"],
                        answer: "Honey"
                    },
                    {
                        question: "How much electrical power does the human brain generate when awake?",
                        options: ["About 5 watts", "About 20 watts", "About 50 watts", "About 100 watts"],
                        answer: "About 20 watts"
                    }
                ]
            };

            const triviaFacts = {
                "deep-sea": [
                    {
                        fact: "The Mariana Trench is deeper than Mount Everest is tall, reaching approximately 11,000 meters (36,000 feet) below the ______.",
                        blank: "surface",
                        options: ["surface", "sea level", "ocean floor", "crust"]
                    },
                    {
                        fact: "Over 80% of our oceans remain unmapped, unobserved, and ______.",
                        blank: "unexplored",
                        options: ["unexplored", "uncharted", "unknown", "unseen"]
                    }
                ],
                "space": [
                    {
                        fact: "A day on Venus is longer than a ______ on Venus.",
                        blank: "year",
                        options: ["month", "week", "year", "century"]
                    },
                    {
                        fact: "There are more stars in the universe than grains of ______ on all the beaches on Earth.",
                        blank: "sand",
                        options: ["dust", "sand", "salt", "rock"]
                    }
                ],
                "history": [
                    {
                        fact: "The shortest war in history was between Britain and Zanzibar on August 27, 1896. Zanzibar surrendered after ______ minutes.",
                        blank: "38",
                        options: ["10", "38", "60", "120"]
                    },
                    {
                        fact: "Ancient Romans used to clean and whiten their teeth with a mixture of urine and ______ milk.",
                        blank: "goat's",
                        options: ["cow's", "sheep's", "goat's", "camel's"]
                    }
                ],
                "science": [
                    {
                        fact: "Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old and still ______.",
                        blank: "edible",
                        options: ["sweet", "fresh", "edible", "preserved"]
                    },
                    {
                        fact: "The human brain generates about 20 watts of electrical power when awake, enough to light a dim ______.",
                        blank: "lightbulb",
                        options: ["candle", "lightbulb", "torch", "fire"]
                    }
                ]
            };

            // Function to update the last update time in the footer
            const updateLastUpdateTime = () => {
                const now = new Date();
                lastUpdateTime.textContent = now.toLocaleString();
            };

            // Initial update
            updateLastUpdateTime();
            // Update every minute (or as desired)
            setInterval(updateLastUpdateTime, 60000);

            const applyTheme = (themeName) => {
                const theme = themes[themeName];
                if (!theme) return;

                const root = document.documentElement;
                root.style.setProperty('--bg-color-primary', theme.primaryBg);
                root.style.setProperty('--bg-color-secondary', theme.secondaryBg);
                root.style.setProperty('--text-color', theme.textColor);
                root.style.setProperty('--footer-bg', theme.footerBg);
                root.style.setProperty('--glass-bg', theme.glassBg);
                root.style.setProperty('--glass-border', theme.glassBorder);
                root.style.setProperty('--title-color', theme.titleColor);
                root.style.setProperty('--main-action-btn', theme.mainActionBtn);
                root.style.setProperty('--main-action-btn-hover', theme.mainActionBtnHover);
                root.style.setProperty('--theme-indicator-color', theme.themeIndicatorColor);
                root.style.setProperty('--favorite-btn-color', theme.favoriteBtnColor);
                root.style.setProperty('--favorite-btn-hover', theme.favoriteBtnHover);
                root.style.setProperty('--share-btn-color', theme.shareBtnColor);
                root.style.setProperty('--share-btn-hover', theme.shareBtnHover);
                root.style.setProperty('--rating-active-color', theme.ratingActiveColor);
                root.style.setProperty('--rating-text-color', theme.ratingTextColor);
                root.style.setProperty('--category-select-bg', theme.categorySelectBg);
                root.style.setProperty('--category-select-border', theme.categorySelectBorder);
                root.style.setProperty('--search-input-bg', theme.searchInputBg);
                root.style.setProperty('--search-input-border', theme.searchInputBorder);
                root.style.setProperty('--search-input-text', theme.searchInputText);
                root.style.setProperty('--fact-card-bg', theme.factCardBg);
                root.style.setProperty('--fact-card-border', theme.factCardBorder);
                root.style.setProperty('--fact-of-day-glow', theme.factOfDayGlow);
                root.style.setProperty('--carousel-control-color', theme.carouselControlColor);
                root.style.setProperty('--carousel-control-hover', theme.carouselControlHover);
                root.style.setProperty('--trivia-correct-color', theme.triviaCorrectColor);
                root.style.setProperty('--trivia-incorrect-color', theme.triviaIncorrectColor);
                root.style.setProperty('--streak-color', theme.streakColor);
                root.style.setProperty('--streak-glow', theme.streakGlow);
                root.style.setProperty('--quiz-correct-color', theme.triviaCorrectColor); /* Reusing for quiz */
                root.style.setProperty('--quiz-incorrect-color', theme.triviaIncorrectColor); /* Reusing for quiz */


                siteTitle.textContent = theme.title;
                currentThemeIndicator.textContent = theme.title;
            };

            const getRandomFact = (category) => {
                const categoryFacts = facts[category];
                if (!categoryFacts || categoryFacts.length === 0) {
                    return "No facts available for this category.";
                }
                const randomIndex = Math.floor(Math.random() * categoryFacts.length);
                return categoryFacts[randomIndex];
            };

            const displayFact = (factText, category) => {
                factDisplay.textContent = factText;
                factDisplay.classList.remove('fact-display-animation'); // Reset animation
                void factDisplay.offsetWidth; // Trigger reflow
                factDisplay.classList.add('fact-display-animation'); // Re-add animation
                factDisplay.classList.add('blurred-fact'); // Initially blur the fact
                revealFactBtn.style.display = 'block'; // Show reveal button
                currentFact = { text: factText, category: category, rating: 0 };
                popularityScore.textContent = `Rating: ${currentFact.rating}`;
                thumbsUpBtn.classList.remove('active');
                thumbsDownBtn.classList.remove('active');
                // Check if the current fact is in favorites and update the button
                const isFavorited = favoriteFacts.some(f => f.text === currentFact.text);
                if (isFavorited) {
                    favoriteBtn.classList.add('favorited');
                } else {
                    favoriteBtn.classList.remove('favorited');
                }
            };

            revealFactBtn.addEventListener('click', () => {
                factDisplay.classList.remove('blurred-fact');
                revealFactBtn.style.display = 'none';
            });

            factDisplay.addEventListener('click', () => {
                if (factDisplay.classList.contains('blurred-fact')) {
                    factDisplay.classList.remove('blurred-fact');
                    revealFactBtn.style.display = 'none';
                }
            });

            const addFactToHistory = (fact) => {
                // Only add if it's a new fact or different from the last one
                if (factHistory.length === 0 || factHistory[0].text !== fact.text) {
                    factHistory.unshift(fact); // Add to the beginning
                    if (factHistory.length > 10) { // Keep history to a reasonable size
                        factHistory.pop();
                    }
                }
            };

            const showNextFact = () => {
                addFactToHistory(currentFact);
                const selectedCategory = factCategorySelect.value;
                displayFact(getRandomFact(selectedCategory), selectedCategory);
                factDisplay.classList.add('blurred-fact'); // Re-apply blur for new fact
                revealFactBtn.style.display = 'block'; // Show reveal button for new fact
                factStreak++; // Increment streak
                updateStreakDisplay();
            };

            const showPreviousFact = () => {
                if (factHistory.length > 1) {
                    const previousFact = factHistory.shift(); // Remove current fact from history
                    const actualPreviousFact = factHistory.shift(); // Get the fact before that
                    if (actualPreviousFact) {
                        displayFact(actualPreviousFact.text, actualPreviousFact.category); // Display previous fact
                        factDisplay.classList.add('blurred-fact'); // Re-apply blur for previous fact
                        revealFactBtn.style.display = 'block'; // Show reveal button for previous fact
                        // Re-add the "current" fact (which was the first item in history) back to the beginning
                        // so that if they go forward again, it's there.
                        factHistory.unshift(previousFact);
                    } else {
                        // If there's no actual previous fact, just display the one we shifted off
                        displayFact(previousFact.text, previousFact.category);
                        factDisplay.classList.add('blurred-fact'); // Re-apply blur
                        revealFactBtn.style.display = 'block'; // Show reveal button
                    }
                } else if (factHistory.length === 1) {
                    // If only one item in history, it's the previous fact. Display it and clear history.
                    const previousFact = factHistory.shift();
                    if (previousFact) {
                        displayFact(previousFact.text, previousFact.category);
                        factDisplay.classList.add('blurred-fact'); // Re-apply blur
                        revealFactBtn.style.display = 'block'; // Show reveal button
                    }
                } else {
                    // No history, just get a new random fact
                    showNextFact();
                }
                resetStreak(); // Reset streak if navigating history
            };

            nextFactBtn.addEventListener('click', () => {
                showNextFact();
                startCarousel(); // Restart carousel if it was playing
            });
            prevFactBtn.addEventListener('click', () => {
                showPreviousFact();
                resetStreak(); // Reset streak if navigating history
            });

            discoverNewFactBtn.addEventListener('click', () => {
                showNextFact();
                pauseCarousel(); // Pause carousel when manually discovering a new fact
            });

            const startCarousel = () => {
                if (carouselInterval) clearInterval(carouselInterval);
                carouselInterval = setInterval(() => {
                    showNextFact();
                }, CAROUSEL_SPEED);
                playPauseCarouselBtn.textContent = "Pause Carousel";
                isCarouselPlaying = true;
            };

            const pauseCarousel = () => {
                clearInterval(carouselInterval);
                playPauseCarouselBtn.textContent = "Play Carousel";
                isCarouselPlaying = false;
            };

            playPauseCarouselBtn.addEventListener('click', () => {
                if (isCarouselPlaying) {
                    pauseCarousel();
                } else {
                    startCarousel();
                }
            });

            thumbsUpBtn.addEventListener('click', () => {
                if (!thumbsUpBtn.classList.contains('active')) {
                    currentFact.rating++;
                    popularityScore.textContent = `Rating: ${currentFact.rating}`;
                    thumbsUpBtn.classList.add('active');
                    thumbsDownBtn.classList.remove('active');
                }
                resetStreak(); // Reset streak if rating
            });

            thumbsDownBtn.addEventListener('click', () => {
                if (!thumbsDownBtn.classList.contains('active')) {
                    currentFact.rating--;
                    popularityScore.textContent = `Rating: ${currentFact.rating}`;
                    thumbsDownBtn.classList.add('active');
                    thumbsUpBtn.classList.remove('active');
                }
                resetStreak(); // Reset streak if rating
            });

            favoriteBtn.addEventListener('click', () => {
                const index = favoriteFacts.findIndex(f => f.text === currentFact.text);
                if (index === -1) {
                    favoriteFacts.push(currentFact);
                    favoriteBtn.classList.add('favorited');
                } else {
                    favoriteFacts.splice(index, 1);
                    favoriteBtn.classList.remove('favorited');
                }
                resetStreak(); // Reset streak if favoriting/unfavoriting
            });

            shareFactBtn.addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: document.title,
                        text: currentFact.text,
                        url: window.location.href
                    }).catch((error) => console.error('Error sharing:', error));
                } else {
                    alert('Sharing not supported on this browser. You can manually copy the fact: ' + currentFact.text);
                }
                resetStreak(); // Reset streak if sharing
            });

            const populateModal = (listElement, factsArray) => {
                listElement.innerHTML = '';
                if (factsArray.length === 0) {
                    listElement.innerHTML = '<li>No facts to display.</li>';
                    return;
                }
                factsArray.forEach(fact => {
                    const li = document.createElement('li');
                    li.textContent = fact.text;
                    listElement.appendChild(li);
                });
            };

            viewHistoryBtn.addEventListener('click', () => {
                populateModal(historyList, factHistory);
                historyModal.style.display = 'block';
                resetStreak(); // Reset streak if viewing history
            });

            viewFavoritesBtn.addEventListener('click', () => {
                populateModal(favoritesList, favoriteFacts);
                favoritesModal.style.display = 'block';
                resetStreak(); // Reset streak if viewing favorites
            });

            closeHistoryModal.addEventListener('click', () => {
                historyModal.style.display = 'none';
            });

            closeFavoritesModal.addEventListener('click', () => {
                favoritesModal.style.display = 'none';
            });

            closeQuizModal.addEventListener('click', () => {
                quizModal.style.display = 'none';
            });

            closeSearchResultsModal.addEventListener('click', () => {
                searchResultsModal.style.display = 'none';
            });

            closeFactChallengeModal.addEventListener('click', () => {
                factChallengeModal.style.display = 'none';
            });

            closeFactTriviaModal.addEventListener('click', () => {
                factTriviaModal.style.display = 'none';
            });

            closeFactScrambleModal.addEventListener('click', () => { // New close button
                factScrambleModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target == historyModal) {
                    historyModal.style.display = 'none';
                }
                if (event.target == favoritesModal) {
                    favoritesModal.style.display = 'none';
                }
                if (event.target == quizModal) {
                    quizModal.style.display = 'none';
                }
                if (event.target == searchResultsModal) {
                    searchResultsModal.style.display = 'none';
                }
                if (event.target == factChallengeModal) {
                    factChallengeModal.style.display = 'none';
                }
                if (event.target == factTriviaModal) {
                    factTriviaModal.style.display = 'none';
                }
                if (event.target == factScrambleModal) { // New modal close
                    factScrambleModal.style.display = 'none';
                }
            });

            // Fact of the Day Feature
            let factOfTheDayInterval = null;
            const FACT_OF_THE_DAY_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

            const setFactOfTheDay = () => {
                const selectedCategory = factCategorySelect.value;
                const fact = getRandomFact(selectedCategory);
                factOfTheDayContent.textContent = fact;
                localStorage.setItem('factOfTheDay', JSON.stringify({
                    text: fact,
                    timestamp: Date.now(),
                    category: selectedCategory
                }));
            };

            const getFactOfTheDay = () => {
                const storedFact = localStorage.getItem('factOfTheDay');
                if (storedFact) {
                    return JSON.parse(storedFact);
                }
                return null;
            };

            const updateCountdown = () => {
                const storedFact = getFactOfTheDay();
                if (!storedFact) {
                    nextFactOfDayCountdown.textContent = "Loading next fact...";
                    return;
                }

                const now = Date.now();
                const timeElapsed = now - storedFact.timestamp;
                const timeLeft = FACT_OF_THE_DAY_DURATION - timeElapsed;

                if (timeLeft <= 0) {
                    setFactOfTheDay();
                    updateCountdown(); // Recalculate for the new fact
                    return;
                }

                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                nextFactOfDayCountdown.textContent = `Next fact in: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };

            factOfTheDayBtn.addEventListener('click', () => {
                // Hide the regular fact display
                factDisplay.textContent = ''; // Clear current fact display
                factOfTheDaySection.style.display = 'block';
                utilityButtonsContainer.style.display = 'none'; // Hide utility buttons when FOTD is active
                discoverNewFactBtn.style.display = 'none'; // Hide discover button
                moreOptionsBtn.style.display = 'none'; // Hide more options button

                const storedFact = getFactOfTheDay();
                if (!storedFact || (Date.now() - storedFact.timestamp) >= FACT_OF_THE_DAY_DURATION) {
                    setFactOfTheDay();
                }
                factOfTheDayContent.textContent = getFactOfTheDay().text;
                updateCountdown();
                if (factOfTheDayInterval) {
                    clearInterval(factOfTheDayInterval);
                }
                factOfTheDayInterval = setInterval(updateCountdown, 1000);
                resetStreak(); // Reset streak if viewing Fact of the Day
            });

            // Quiz Feature Logic
            let currentQuiz = null;

            const getRandomQuiz = (category) => {
                const categoryQuizzes = quizzes[category];
                if (!categoryQuizzes || categoryQuizzes.length === 0) {
                    return null;
                }
                const randomIndex = Math.floor(Math.random() * categoryQuizzes.length);
                return categoryQuizzes[randomIndex];
            };

            const startQuiz = () => {
                const selectedCategory = factCategorySelect.value;
                currentQuiz = getRandomQuiz(selectedCategory);

                if (!currentQuiz) {
                    alert("No quiz available for this category yet!");
                    return;
                }

                quizQuestion.textContent = currentQuiz.question;
                quizOptions.innerHTML = '';
                quizFeedback.textContent = '';
                nextQuizBtn.style.display = 'none';

                currentQuiz.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.addEventListener('click', () => checkAnswer(button, option));
                    quizOptions.appendChild(button);
                });

                quizModal.style.display = 'block';
                utilityButtonsContainer.style.display = 'none'; // Hide utility buttons when quiz is active
                discoverNewFactBtn.style.display = 'none'; // Hide discover button
                moreOptionsBtn.style.display = 'none'; // Hide more options button
                resetStreak(); // Reset streak if starting quiz
            };

            const checkAnswer = (selectedButton, selectedOption) => {
                Array.from(quizOptions.children).forEach(button => {
                    button.disabled = true; // Disable all buttons after selection
                    if (button.textContent === currentQuiz.answer) {
                        button.classList.add('correct');
                    } else if (button === selectedButton) {
                        button.classList.add('incorrect');
                    }
                });

                if (selectedOption === currentQuiz.answer) {
                    quizFeedback.textContent = "Correct! 🎉";
                    quizFeedback.style.color = 'var(--quiz-correct-color)';
                } else {
                    quizFeedback.textContent = `Incorrect. The answer was: ${currentQuiz.answer}`;
                    quizFeedback.style.color = 'var(--quiz-incorrect-color)';
                }
                nextQuizBtn.style.display = 'block';
            };

            quizMeBtn.addEventListener('click', startQuiz);
            nextQuizBtn.addEventListener('click', startQuiz); // Allow user to get another quiz question

            // Fact Search Feature Logic
            searchFactBtn.addEventListener('click', () => {
                const query = searchInput.value.toLowerCase();
                const allFacts = Object.values(facts).flat(); // Get all facts from all categories
                const results = allFacts.filter(fact => fact.toLowerCase().includes(query));

                searchResultsList.innerHTML = '';
                if (results.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No facts found matching your search.';
                    searchResultsList.appendChild(li);
                } else {
                    results.forEach(factText => {
                        const li = document.createElement('li');
                        li.textContent = factText;
                        searchResultsList.appendChild(li);
                    });
                }
                searchResultsModal.style.display = 'block';
                utilityButtonsContainer.style.display = 'none'; // Hide utility buttons when search results are active
                discoverNewFactBtn.style.display = 'none'; // Hide discover button
                moreOptionsBtn.style.display = 'none'; // Hide more options button
                resetStreak(); // Reset streak if searching
            });

            // Fact Challenge Feature Logic
            let currentChallenge = null;

            const startFactChallenge = () => {
                const allCategories = Object.keys(facts);
                if (allCategories.length < 2) {
                    alert("Not enough categories for a fact challenge!");
                    return;
                }

                // Pick a random category for the correct answer
                const correctCategoryIndex = Math.floor(Math.random() * allCategories.length);
                const correctCategory = allCategories[correctCategoryIndex];

                // Pick a random fact from the correct category
                const challengeFactText = getRandomFact(correctCategory);

                currentChallenge = {
                    fact: challengeFactText,
                    correctCategory: correctCategory
                };

                challengeFactDisplay.textContent = currentChallenge.fact;

                challengeOptions.innerHTML = '';
                challengeFeedback.textContent = '';
                nextChallengeBtn.style.display = 'none';

                // Generate options: correct category + 2-3 incorrect categories
                let options = [correctCategory];
                let incorrectCategories = allCategories.filter(cat => cat !== correctCategory);
                // Shuffle incorrect categories and pick a few
                for (let i = incorrectCategories.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [incorrectCategories[i], incorrectCategories[j]] = [incorrectCategories[j], incorrectCategories[i]];
                }
                options = options.concat(incorrectCategories.slice(0, Math.min(incorrectCategories.length, 2))); // Add up to 2 incorrect options

                // Shuffle all options
                for (let i = options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [options[i], options[j]] = [options[j], options[i]];
                }

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.charAt(0).toUpperCase() + option.slice(1).replace('-', ' '); // Capitalize and format
                    button.dataset.category = option; // Store original category name
                    button.addEventListener('click', () => checkChallengeAnswer(button, option));
                    challengeOptions.appendChild(button);
                });

                factChallengeModal.style.display = 'block';
                utilityButtonsContainer.style.display = 'none'; // Hide utility buttons when challenge is active
                discoverNewFactBtn.style.display = 'none'; // Hide discover button
                moreOptionsBtn.style.display = 'none'; // Hide more options button
                resetStreak(); // Reset streak if starting challenge
            };

            const checkChallengeAnswer = (selectedButton, selectedOption) => {
                Array.from(challengeOptions.children).forEach(button => {
                    button.disabled = true;
                    if (button.dataset.category === currentChallenge.correctCategory) {
                        button.classList.add('correct');
                    } else if (button === selectedButton) {
                        button.classList.add('incorrect');
                    }
                });

                if (selectedOption === currentChallenge.correctCategory) {
                    challengeFeedback.textContent = "Correct! You nailed the category! 🎉";
                    challengeFeedback.style.color = 'var(--quiz-correct-color)';
                } else {
                    challengeFeedback.textContent = `Incorrect. The fact was from the ${currentChallenge.correctCategory.charAt(0).toUpperCase() + currentChallenge.correctCategory.slice(1).replace('-', ' ')} category.`;
                    challengeFeedback.style.color = 'var(--quiz-incorrect-color)';
                }
                nextChallengeBtn.style.display = 'block';
            };

            factChallengeBtn.addEventListener('click', startFactChallenge);
            nextChallengeBtn.addEventListener('click', startFactChallenge);

            // Fact Trivia Feature Logic
            let currentTrivia = null;

            const getRandomTrivia = (category) => {
                const categoryTrivia = triviaFacts[category];
                if (!categoryTrivia || categoryTrivia.length === 0) {
                    return null;
                }
                const randomIndex = Math.floor(Math.random() * categoryTrivia.length);
                return categoryTrivia[randomIndex];
            };

            const startFactTrivia = () => {
                const selectedCategory = factCategorySelect.value;
                currentTrivia = getRandomTrivia(selectedCategory);

                if (!currentTrivia) {
                    alert("No trivia available for this category yet!");
                    return;
                }

                triviaFactDisplay.textContent = currentTrivia.fact;

                triviaOptions.innerHTML = '';
                triviaFeedback.textContent = '';
                nextTriviaBtn.style.display = 'none';

                // Shuffle options
                let options = [...currentTrivia.options];
                for (let i = options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [options[i], options[j]] = [options[j], options[i]];
                }

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.addEventListener('click', () => checkTriviaAnswer(button, option));
                    triviaOptions.appendChild(button);
                });

                factTriviaModal.style.display = 'block';
                utilityButtonsContainer.style.display = 'none'; // Hide utility buttons when trivia is active
                discoverNewFactBtn.style.display = 'none'; // Hide discover button
                moreOptionsBtn.style.display = 'none'; // Hide more options button
                resetStreak(); // Reset streak if starting trivia
            };

            const checkTriviaAnswer = (selectedButton, selectedOption) => {
                Array.from(triviaOptions.children).forEach(button => {
                    button.disabled = true;
                    if (button.textContent === currentTrivia.blank) {
                        button.classList.add('correct');
                    } else if (button === selectedButton) {
                        button.classList.add('incorrect');
                    }
                });

                if (selectedOption === currentTrivia.blank) {
                    triviaFeedback.textContent = "Correct! You filled the blank! 🎉";
                    triviaFeedback.style.color = 'var(--trivia-correct-color)';
                } else {
                    triviaFeedback.textContent = `Incorrect. The missing word was: ${currentTrivia.blank}`;
                    triviaFeedback.style.color = 'var(--trivia-incorrect-color)';
                }
                nextTriviaBtn.style.display = 'block';
            };

            factTriviaBtn.addEventListener('click', startFactTrivia);
            nextTriviaBtn.addEventListener('click', startFactTrivia);

            // Fact Scramble Feature Logic
            let currentScrambleFact = "";

            const shuffleWords = (text) => {
                const words = text.split(' ');
                for (let i = words.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [words[i], words[j]] = [words[j], words[i]];
                }
                return words.join(' ');
            };

            const startFactScramble = () => {
                const selectedCategory = factCategorySelect.value;
                currentScrambleFact = getRandomFact(selectedCategory);
                const scrambledText = shuffleWords(currentScrambleFact);

                scrambleFactDisplay.textContent = scrambledText;
                scrambleInput.value = '';
                scrambleFeedback.textContent = '';
                checkScrambleBtn.style.display = 'block';
                nextScrambleBtn.style.display = 'none';
                scrambleInput.disabled = false;

                factScrambleModal.style.display = 'block';
                utilityButtonsContainer.style.display = 'none';
                discoverNewFactBtn.style.display = 'none';
                moreOptionsBtn.style.display = 'none';
                resetStreak();
            };

            const checkScrambleAnswer = () => {
                const userAnswer = scrambleInput.value.trim();
                const originalFact = currentScrambleFact.trim();

                scrambleInput.disabled = true;
                checkScrambleBtn.style.display = 'none';
                nextScrambleBtn.style.display = 'block';

                if (userAnswer.toLowerCase() === originalFact.toLowerCase()) {
                    scrambleFeedback.textContent = "Amazing! You unscrambled it! 🎉";
                    scrambleFeedback.style.color = 'var(--quiz-correct-color)';
                } else {
                    scrambleFeedback.textContent = `Not quite. The correct fact was: "${originalFact}"`;
                    scrambleFeedback.style.color = 'var(--quiz-incorrect-color)';
                }
            };

            factScrambleBtn.addEventListener('click', startFactScramble);
            checkScrambleBtn.addEventListener('click', checkScrambleAnswer);
            nextScrambleBtn.addEventListener('click', startFactScramble);


            // More Options button toggle
            moreOptionsBtn.addEventListener('click', () => {
                if (utilityButtonsContainer.style.display === 'none' || utilityButtonsContainer.style.display === '') {
                    utilityButtonsContainer.style.display = 'flex';
                    moreOptionsBtn.textContent = 'Hide Options';
                } else {
                    utilityButtonsContainer.style.display = 'none';
                    moreOptionsBtn.textContent = 'More Options';
                }
            });

            // Fact Streak Logic
            const updateStreakDisplay = () => {
                currentStreakDisplay.textContent = `Fact Streak: ${factStreak}`;
                if (factStreak > 0) {
                    claimStreakBtn.disabled = false;
                    factStreakSection.classList.add('active-streak');
                } else {
                    claimStreakBtn.disabled = true;
                    factStreakSection.classList.remove('active-streak');
                }
            };

            const resetStreak = () => {
                factStreak = 0;
                updateStreakDisplay();
            };

            claimStreakBtn.addEventListener('click', () => {
                if (factStreak > 0) {
                    alert(`You claimed a bonus for a ${factStreak} fact streak! (Feature under development)`);
                    resetStreak();
                }
            });

            // Initial fact display and theme application on load
            // Hardcoding initial theme and fact as per instructions
            const initialCategory = "history";
            const initialFact = "Cleopatra lived closer in time to the invention of the iPhone than to the building of the Great Pyramid of Giza.";

            factCategorySelect.value = initialCategory; // Set the select to the chosen category
            applyTheme(initialCategory);
            displayFact(initialFact, initialCategory); // Initial fact is immediately visible
            factDisplay.classList.add('blurred-fact'); // Apply blur to initial fact
            revealFactBtn.style.display = 'block'; // Show reveal button for initial fact
            startCarousel(); // Start the carousel automatically on load
            updateStreakDisplay(); // Initialize streak display

            // Event listener for category change
            factCategorySelect.addEventListener('change', () => {
                const selectedCategory = factCategorySelect.value;
                applyTheme(selectedCategory);
                displayFact(getRandomFact(selectedCategory), selectedCategory); // New facts are immediately visible
                pauseCarousel(); // Pause carousel on category change
                resetStreak(); // Reset streak on category change
            });
        });
    </script>
</body>
</html>